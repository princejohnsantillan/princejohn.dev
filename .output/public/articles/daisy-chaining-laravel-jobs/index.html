<!DOCTYPE html><html  lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daisy Chaining Laravel Jobs</title>
<meta property="og:image" content="https://princejohn.dev/__og-image__/image/articles/daisy-chaining-laravel-jobs/og.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="600">
<meta property="og:image:type" content="image/png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:src" content="https://princejohn.dev/__og-image__/image/articles/daisy-chaining-laravel-jobs/og.png">
<meta name="twitter:image:width" content="1200">
<meta name="twitter:image:height" content="600">
<meta property="og:title" content="Daisy Chaining Laravel Jobs">
<meta name="description" content="We overcame Laravel Vapor timeout limits by implementing cursor pagination via daisy chaining jobs.">
<meta property="og:description" content="We overcame Laravel Vapor timeout limits by implementing cursor pagination via daisy chaining jobs.">
<link rel="preload" as="fetch" crossorigin="anonymous" href="/articles/daisy-chaining-laravel-jobs/_payload.json?c4a3190a-e3ef-449f-be3a-d5f85a602474">
<style>/*! tailwindcss v3.4.3 | MIT License | https://tailwindcss.com*/*,:after,:before{border:0 solid #e5e7eb;box-sizing:border-box}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;tab-size:4;-webkit-tap-highlight-color:transparent}body{line-height:inherit;margin:0}hr{border-top-width:1px;color:inherit;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-size:1em;font-variation-settings:normal}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:initial}sub{bottom:-.25em}sup{top:-.5em}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{color:inherit;font-family:inherit;font-feature-settings:inherit;font-size:100%;font-variation-settings:inherit;font-weight:inherit;letter-spacing:inherit;line-height:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:initial;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:initial}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}[hidden]{display:none}*,::backdrop,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:#3b82f680;--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-bottom:1.2em;margin-top:1.2em}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:disc;margin-bottom:1.25em;margin-top:1.25em;padding-inline-start:1.625em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.25em}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-bottom:3em;margin-top:3em}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){border-inline-start-color:var(--tw-prose-quote-borders);border-inline-start-width:.25rem;color:var(--tw-prose-quotes);font-style:italic;font-weight:500;margin-bottom:1.6em;margin-top:1.6em;padding-inline-start:1em;quotes:"\201C""\201D""\2018""\2019"}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:2.25em;font-weight:800;line-height:1.1111111;margin-bottom:.8888889em;margin-top:0}.prose :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.5em;font-weight:700;line-height:1.3333333;margin-bottom:1em;margin-top:2em}.prose :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-size:1.25em;font-weight:600;line-height:1.6;margin-bottom:.6em;margin-top:1.6em}.prose :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;line-height:1.5;margin-bottom:.5em;margin-top:1.5em}.prose :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){display:block;margin-bottom:2em;margin-top:2em}.prose :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){border-radius:.3125rem;box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px 0 rgb(var(--tw-prose-kbd-shadows)/10%);color:var(--tw-prose-kbd);font-family:inherit;font-size:.875em;font-weight:500;padding-inline-end:.375em;padding-bottom:.1875em;padding-top:.1875em;padding-inline-start:.375em}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-code);font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:"`"}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);border-radius:.375rem;color:var(--tw-prose-pre-code);font-size:.875em;font-weight:400;line-height:1.7142857;margin-bottom:1.7142857em;margin-top:1.7142857em;overflow-x:auto;padding-inline-end:1.1428571em;padding-bottom:.8571429em;padding-top:.8571429em;padding-inline-start:1.1428571em}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:initial;border-radius:0;border-width:0;color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;line-height:inherit;padding:0}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:none}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;line-height:1.7142857;margin-bottom:2em;margin-top:2em;table-layout:auto;text-align:start;width:100%}.prose :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-th-borders);border-bottom-width:1px}.prose :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-inline-start:.5714286em;vertical-align:bottom}.prose :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-color:var(--tw-prose-td-borders);border-bottom-width:1px}.prose :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:initial}.prose :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-color:var(--tw-prose-th-borders);border-top-width:1px}.prose :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}.prose :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:#00000080;--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0;margin-top:0}.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.5em;margin-top:.5em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:.75em;margin-top:.75em}.prose :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em;margin-top:1.25em}.prose :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}.prose :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:.5714286em;padding-bottom:.5714286em;padding-top:.5714286em;padding-inline-start:.5714286em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:2em;margin-top:2em}.prose :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.sr-only{height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px;clip:rect(0,0,0,0);border-width:0;white-space:nowrap}.static{position:static}.fixed{position:fixed}.m-auto{margin:auto}.mx-auto{margin-left:auto;margin-right:auto}.my-10{margin-bottom:2.5rem;margin-top:2.5rem}.my-5{margin-bottom:1.25rem;margin-top:1.25rem}.mb-0{margin-bottom:0}.mr-6{margin-right:1.5rem}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.h-5{height:1.25rem}.w-5{width:1.25rem}.max-w-4xl{max-width:56rem}.max-w-none{max-width:none}.justify-between{justify-content:space-between}.space-x-3>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-left:calc(.75rem*(1 - var(--tw-space-x-reverse)));margin-right:calc(.75rem*var(--tw-space-x-reverse))}.rounded-sm{border-radius:.125rem}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-bottom:.25rem;padding-top:.25rem}.py-10{padding-bottom:2.5rem;padding-top:2.5rem}.py-4{padding-bottom:1rem;padding-top:1rem}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-sm{font-size:.875rem;line-height:1.25rem}.font-bold{font-weight:700}.text-black{--tw-text-opacity:1;color:rgb(0 0 0/var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}.text-orange-500,.text-primary-500{--tw-text-opacity:1;color:rgb(249 115 22/var(--tw-text-opacity))}.ring-1{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.ring-gray-200{--tw-ring-opacity:1;--tw-ring-color:rgb(229 231 235/var(--tw-ring-opacity))}.transition{transition-duration:.15s;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1)}.\[scout\:flush\]{scout:flush}.\[scout\:import\]{scout:import}.dark\:prose-invert:is(.dark *){--tw-prose-body:var(--tw-prose-invert-body);--tw-prose-headings:var(--tw-prose-invert-headings);--tw-prose-lead:var(--tw-prose-invert-lead);--tw-prose-links:var(--tw-prose-invert-links);--tw-prose-bold:var(--tw-prose-invert-bold);--tw-prose-counters:var(--tw-prose-invert-counters);--tw-prose-bullets:var(--tw-prose-invert-bullets);--tw-prose-hr:var(--tw-prose-invert-hr);--tw-prose-quotes:var(--tw-prose-invert-quotes);--tw-prose-quote-borders:var(--tw-prose-invert-quote-borders);--tw-prose-captions:var(--tw-prose-invert-captions);--tw-prose-kbd:var(--tw-prose-invert-kbd);--tw-prose-kbd-shadows:var(--tw-prose-invert-kbd-shadows);--tw-prose-code:var(--tw-prose-invert-code);--tw-prose-pre-code:var(--tw-prose-invert-pre-code);--tw-prose-pre-bg:var(--tw-prose-invert-pre-bg);--tw-prose-th-borders:var(--tw-prose-invert-th-borders);--tw-prose-td-borders:var(--tw-prose-invert-td-borders)}.hover\:text-gray-700:hover{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}.prose-a\:border-b :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))){border-bottom-width:1px}.prose-a\:border-dashed :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))){border-style:dashed}.prose-a\:font-normal :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))){font-weight:400}.prose-a\:no-underline :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))){text-decoration-line:none}.hover\:prose-a\:border-solid :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))):hover{border-style:solid}.hover\:prose-a\:border-primary-400 :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))):hover{--tw-border-opacity:1;border-color:rgb(251 146 60/var(--tw-border-opacity))}.hover\:prose-a\:text-primary-400 :is(:where(a):not(:where([class~=not-prose],[class~=not-prose] *))):hover{--tw-text-opacity:1;color:rgb(251 146 60/var(--tw-text-opacity))}.prose-pre\:bg-gray-100 :is(:where(pre):not(:where([class~=not-prose],[class~=not-prose] *))){--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity))}.dark\:bg-gray-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity))}.dark\:bg-gray-900:is(.dark *){--tw-bg-opacity:1;background-color:rgb(17 24 39/var(--tw-bg-opacity))}.dark\:text-gray-100:is(.dark *){--tw-text-opacity:1;color:rgb(243 244 246/var(--tw-text-opacity))}.dark\:text-gray-200:is(.dark *){--tw-text-opacity:1;color:rgb(229 231 235/var(--tw-text-opacity))}.dark\:text-primary-400:is(.dark *){--tw-text-opacity:1;color:rgb(251 146 60/var(--tw-text-opacity))}.dark\:ring-gray-700:is(.dark *){--tw-ring-opacity:1;--tw-ring-color:rgb(55 65 81/var(--tw-ring-opacity))}.dark\:hover\:text-gray-300:hover:is(.dark *){--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity))}.dark\:prose-pre\:bg-gray-900 :is(:where(pre):not(:where([class~=not-prose],[class~=not-prose] *))):is(.dark *){--tw-bg-opacity:1;background-color:rgb(17 24 39/var(--tw-bg-opacity))}@media (min-width:640px){.sm\:rounded-lg{border-radius:.5rem}.sm\:px-8{padding-left:2rem;padding-right:2rem}.sm\:pb-10{padding-bottom:2.5rem}.sm\:pt-6{padding-top:1.5rem}.sm\:shadow{--tw-shadow:0 1px 3px 0 #0000001a,0 1px 2px -1px #0000001a;--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}}</style>
<style>.icon[data-v-e8d572f6]{display:inline-block;vertical-align:middle}</style>
<style>body{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity));--tw-text-opacity:1;color:rgb(0 0 0/var(--tw-text-opacity))}body:is(.dark *){--tw-bg-opacity:1;background-color:rgb(17 24 39/var(--tw-bg-opacity));--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}</style>
<style>.hl{border-radius:.125rem;--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity));font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:.875rem;line-height:1.25rem;padding:.25rem .5rem;--tw-text-opacity:1;color:rgb(249 115 22/var(--tw-text-opacity))}</style>
<style>pre code .line{display:block;min-height:1rem}</style>
<link rel="stylesheet" href="/_nuxt/entry.t2KMju9R.css">
<link rel="stylesheet" href="/_nuxt/ProsePre.CchFRBtv.css">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/Cl2heraV.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BI4QBp2F.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BPVwktHF.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/Cb--4LqO.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/Binr_0r6.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DhRlBeeQ.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/D0Rp9lYY.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BF5JD_XB.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/PkFAm3Ma.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/CnW-ipzW.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/JVMvW8c0.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DH70mlOc.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BuZZtRsw.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/TJNKaaIt.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BLuT4WmE.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/BUXwM9zx.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DWomzGRg.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DcYeDlq7.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/BZo_ZfnJ.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/BNfGnm9U.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/ClJNi3h6.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/wQKIpQk7.js">
<script type="module" src="/_nuxt/Cl2heraV.js" crossorigin></script><script>"use strict";(()=>{const a=window,e=document.documentElement,c=window.localStorage,d=["dark","light"],n=c&&c.getItem&&c.getItem("nuxt-color-mode")||"system";let l=n==="system"?f():n;const i=e.getAttribute("data-color-mode-forced");i&&(l=i),r(l),a["__NUXT_COLOR_MODE__"]={preference:n,value:l,getColorScheme:f,addColorScheme:r,removeColorScheme:u};function r(o){const t=""+o+"",s="";e.classList?e.classList.add(t):e.className+=" "+t,s&&e.setAttribute("data-"+s,o)}function u(o){const t=""+o+"",s="";e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(t,"g"),""),s&&e.removeAttribute("data-"+s)}function m(o){return a.matchMedia("(prefers-color-scheme"+o+")")}function f(){if(a.matchMedia&&m("").media!=="not all"){for(const o of d)if(m(":"+o).matches)return o}return"light"}})();
</script></head><body><div id="__nuxt"><!--[--><!----><div class="sm:pt-6 sm:pb-10"><!----><!----><!----><div class="nuxt-loading-indicator" style="position:fixed;top:0;right:0;left:0;pointer-events:none;width:auto;height:3px;opacity:0;background:#f97316;background-size:Infinity% auto;transform:scaleX(0%);transform-origin:left;transition:transform 0.1s, height 0.4s, opacity 0.4s;z-index:999999;"></div><div class="flex justify-between max-w-4xl px-4 py-4 mx-auto sm:px-8"><div class="text-gray-700 dark:text-gray-200"><!--[--><!--[--><a href="/" class="mr-6">Prince John</a><a href="/articles" class="mr-6">Articles</a><!--]--><!--]--></div><div class="space-x-3 transition text-gray-500"><a target="_blank" href="https://x.com/pjsantillan" title="Twitter" class="dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon w-5 h-5" style="" width="1em" height="1em" viewBox="0 0 512 512" data-v-e8d572f6><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2L487 464H345L233.7 318.6L106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg></a><a target="_blank" href="https://github.com/princejohnsantillan" title="GitHub" class="dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon w-5 h-5" style="" width="1em" height="1em" viewBox="0 0 496 512" data-v-e8d572f6><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2"/></svg></a><a target="_blank" href="https://linkedin.com/in/princejs" title="LinkedIn" class="dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon w-5 h-5" style="" width="1em" height="1em" viewBox="0 0 448 512" data-v-e8d572f6><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9z"/></svg></a><button aria-label="Color Mode" class="inline-block w-5 dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300"><span>...</span></button></div></div><!--[--><div class="document-driven-page"><div class="max-w-4xl px-4 py-10 m-auto bg-white sm:px-8 sm:shadow dark:bg-gray-800 ring-1 ring-gray-200 dark:ring-gray-700 sm:rounded-lg"><main class="max-w-none prose dark:prose-invert prose-pre:bg-gray-100 dark:prose-pre:bg-gray-900 hover:prose-a:text-primary-400 prose-a:font-normal prose-a:no-underline prose-a:border-dashed prose-a:border-b hover:prose-a:border-solid hover:prose-a:border-primary-400"><div class="my-10"><h1 class="mb-0 text-primary-500">Daisy Chaining Laravel Jobs</h1><span class="text-sm">Published on June 08, 2024</span></div><!--[--><div><p><!--[-->So at work we needed to add Laravel scout, we decided to go with <a href="https://typesense.org/" rel="nofollow"><!--[-->Typesense<!--]--></a>. <br>
This was fairly easy to set up, just follow the <a href="https://laravel.com/docs/11.x/scout#typesense" rel="nofollow"><!--[-->docs<!--]--></a>.<!--]--></p><ul><!--[--><li><!--[-->We tested locally, using a dockerized Typesense via Laravel Sail. Import worked, search worked! Easy! ‚úÖ<!--]--></li><li><!--[-->We tested on staging, using Laravel Vapor. Import worked, search worked! Easy! ‚úÖ<!--]--></li><li><!--[-->We deployed to production, using Laravel Vapor. Import... failed! ‚ùå üò±<!--]--></li><!--]--></ul><h2 id="what-happened"><a href="#what-happened"><!--[-->What happened?<!--]--></a></h2><p><!--[-->In local we tested using <u>hundreds</u> of rows. In staging we tested using <u>thousands</u> of rows. But production had <u>millions</u> of rows!<!--]--></p><p><!--[-->We ran <span class="hl">php artisan scout:import &quot;App\Models\Record&quot;</span> and it timed out. Ok maybe setting <span class="hl">SCOUT_QUEUE</span> to <span class="hl">true</span> is the only thing we need here. We changed it, redeployed, and reran the command; sadly it still timed out. Good news is we were seeing hundreds of jobs being processed, some of them successful and some failed. The errors were caused by <span class="hl">exceeding maximum retries</span> and <span class="hl">database connection issues</span>.<!--]--></p><p><!--[-->The model we were trying to import was using a view as its table so we reviewed the underlying query. We found out that it was inefficient because a couple of indexes were missing. We fixed the view and at the same time made a few Vapor config updates that we thought would help. We increased the <span class="hl">queue-memory</span> and <span class="hl">queue-timeout</span>, reduced the <span class="hl">queue-concurrency</span> value to avoid maxing out our database connections, and defined a dedicated queue so we can clear it by itself when we needed to.<!--]--></p><!--[--><pre class="language-yml shiki shiki-themes github-dark github-light" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">environments</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">:
</span></span><span class="line" line="2"><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">  production</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">:
</span></span><span class="line" line="3"><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">    queue-memory</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">2048
</span></span><span class="line" line="4"><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">    queue-timeout</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">300
</span></span><span class="line" line="5"><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">      queues</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">:
</span></span><span class="line" line="6"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        - </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">default-production
</span></span><span class="line" line="7"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        - </span><span style="--shiki-dark:#85E89D;--shiki-default:#22863A">scout-production</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">50
</span></span></code><!--]--></pre><!--]--><p><!--[-->Ok, hopefully this does it. Again, we pushed the changes, redeployed, and reran the command. This time around the jobs were all successful but unfortunately the artisan command still timed out and couldn&#39;t complete the import. Not there yet but it&#39;s good progress, maybe increasing the <span class="hl">cli-timeout</span> is all we need here. We implemented the change unfortunately the command still times out. What are we doing wrong?<!--]--></p><p><!--[-->We found ourselves source diving the <span class="hl">scout:import</span> command. And luckily we found the culprit for our issues. See <a href="https://github.com/laravel/scout/blob/49d2be17c1ff59bc26867cfc8bdafff52aa3cdaa/src/SearchableScope.php#L34-L42" rel="nofollow"><!--[-->SearchableScope.php<!--]--></a>.<!--]--></p><!--[--><pre class="language-php shiki shiki-themes github-dark github-light" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">$builder</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">macro</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;searchable&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">function</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> (</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">EloquentBuilder</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $builder, $chunk </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">) {
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    $scoutKeyName </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $builder</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">getModel</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">getScoutKeyName</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">();
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    $builder</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">chunkById</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($chunk </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">?:</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> config</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;scout.chunk.searchable&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">500</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">), </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">function</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> ($models) {
</span></span><span class="line" line="5"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $models</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">filter</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">shouldBeSearchable</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">searchable</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">();
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">        event</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">new</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> ModelsImported</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($models));
</span></span><span class="line" line="8"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    }, $builder</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">qualifyColumn</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($scoutKeyName), $scoutKeyName);
</span></span><span class="line" line="9"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">});
</span></span></code><!--]--></pre><!--]--><p><!--[--><span class="hl">chunkById</span> here works until it doesn&#39;t. Because chunk is just a loop, the more records you have the longer this loop will take. Unfortunately for us we were trying to import more than 2M rows, making us hit our Vapor CLI timeout.<!--]--></p><h2 id="how-did-we-solve-it"><a href="#how-did-we-solve-it"><!--[-->How did we solve it?<!--]--></a></h2><p><!--[-->So now that we know the issue, time to write a solution. What do we need?<!--]--></p><ul><!--[--><li><!--[-->A replacement command that can scale<!--]--></li><li><!--[-->A job that performs the import through a queue<!--]--></li><!--]--></ul><p><!--[-->What do we need to consider?<!--]--></p><ul><!--[--><li><!--[-->CLI timeout<!--]--></li><li><!--[-->Queue timeout<!--]--></li><li><!--[-->Throttling<!--]--></li><!--]--></ul><p><!--[-->The solution we came up with is <span class="hl">daisy chaining jobs</span>. We can accomplish daisy chaining simply by dispatching another instance of the same job within the job itself. To avoid infinite loop we have to make sure we have an exit logic in place. For our case here it stops dispatching a new job when it&#39;s at the end of the table.<!--]--></p><!--[--><pre class="language-php shiki shiki-themes github-dark github-light" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">class</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> MakeModelSearchable</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> implements</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> ShouldQueue
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">{
</span></span><span class="line" line="3"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">    public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> function</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> __construct</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(
</span></span><span class="line" line="4"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> string</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $class,
</span></span><span class="line" line="5"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">|</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">string</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">|</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $cursor </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">,
</span></span><span class="line" line="6"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $chunk </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> 500
</span></span><span class="line" line="7"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    ) {
</span></span><span class="line" line="8"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    }
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">    public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> function</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> handle</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">:</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> void
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    {
</span></span><span class="line" line="12"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D">        /** </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">@var</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> Model</span><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D"> $model */
</span></span><span class="line" line="13"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $model </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> (</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">class);
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D">        // CURSOR BASED PAGINATION
</span></span><span class="line" line="16"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $keys </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $model</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">::</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">query</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()
</span></span><span class="line" line="17"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">            -&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">limit</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">chunk)
</span></span><span class="line" line="18"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">            -&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">when</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">cursor </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">!==</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">function</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">Builder</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $q){
</span></span><span class="line" line="19"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">              return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $q</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">where</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($model</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">getKeyName</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(), </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;&gt;&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">cursor);
</span></span><span class="line" line="20"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">            })
</span></span><span class="line" line="21"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">            -&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">pluck</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($model</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">getKeyName</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">());
</span></span><span class="line" line="22"><span emptylineplaceholder="true">
</span></span><span class="line" line="23"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D">        // THIS IS OUR EXIT LOGIC
</span></span><span class="line" line="24"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($keys</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">isEmpty</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()) {
</span></span><span class="line" line="25"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">            return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">;
</span></span><span class="line" line="26"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        }
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D">        // CALL SCOUT&#39;S SEARCHABLE METHOD TO PERFORM THE IMPORT
</span></span><span class="line" line="29"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $model</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">::</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">query</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()
</span></span><span class="line" line="30"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">          -&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">whereIn</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($model</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">getKeyName</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(), $keys)
</span></span><span class="line" line="31"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">          -&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">searchable</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">();
</span></span><span class="line" line="32"><span emptylineplaceholder="true">
</span></span><span class="line" line="33"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D">        // WE DISPATCH ANOTHER JOB WITH A NEW CURSOR
</span></span><span class="line" line="34"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        static::</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">dispatch</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">class, $keys</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">last</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(), </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">$this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">chunk);
</span></span><span class="line" line="35"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    }
</span></span><span class="line" line="36"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">}
</span></span></code><!--]--></pre><!--]--><p><!--[-->We start the import process with a command that dispatches the first job.<!--]--></p><!--[--><pre class="language-php shiki shiki-themes github-dark github-light" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">class</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> ImportScoutModel</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> extends</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> Command
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">{
</span></span><span class="line" line="3"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">    protected</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E"> $signature </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62"> &#39;app:import-scout-model
</span></span><span class="line" line="4"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">            {model : Class name of model to bulk import}
</span></span><span class="line" line="5"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">            {--c|chunk= : The number of records to import at a time (Defaults to configuration value: `scout.chunk.searchable`)}&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">;
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">    public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> function</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> handle</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">()</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">:</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> int
</span></span><span class="line" line="8"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    {
</span></span><span class="line" line="9"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $class </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> $this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">argument</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;model&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">);
</span></span><span class="line" line="10"><span emptylineplaceholder="true">
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">        $chunk </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5"> $this</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">-&gt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">option</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;chunk&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">??</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1"> config</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62">&#39;scout.chunk.searchable&#39;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">);
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">        MakeModelSearchable</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">::</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1">dispatch</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">($class, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">, $chunk);
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49">        return</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49"> self::</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5">SUCCESS</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">;
</span></span><span class="line" line="16"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">    }
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E">}
</span></span></code><!--]--></pre><!--]--><p><!--[-->With this approach we are able to address the CLI timeout because it&#39;s only responsible for dispatching the first job. Queue timeout was already addressed by optimizing our queries. Throttling issues can easily be addressed by tweaking our job class&#39; backoff strategy.<!--]--></p><p><!--[-->This solution is inspired by <a href="https://planetscale.com/learn/courses/mysql-for-developers/examples/cursor-pagination" rel="nofollow"><!--[-->Aaron Francis&#39; cursor pagination lesson<!--]--></a>.<!--]--></p><h2 id="lessons-learned-along-the-way"><a href="#lessons-learned-along-the-way"><!--[-->Lessons learned along the way<!--]--></a></h2><ul><!--[--><li><!--[-->When pairing Laravel Scout with Typesense and queue is set to true, be sure to restart your queue after running a <span class="hl">scout:flush</span> You&#39;re gonna get a <span class="hl">Typesense\Exceptions\ObjectNotFound</span> exception if you do an import without restarting.<!--]--></li><!--]--></ul><style>html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}</style></div><!--]--></main></div></div><!--]--></div><!--]--></div><div id="teleports"></div><script id="nuxt-og-image-options" type="application/json">{"props":{"title":"Daisy Chaining Laravel Jobs","excerpt":"We overcame Laravel Vapor timeout limits by implementing cursor pagination via daisy chaining jobs."}}</script>
<script type="application/json" id="__NUXT_DATA__" data-ssr="true" data-src="/articles/daisy-chaining-laravel-jobs/_payload.json?c4a3190a-e3ef-449f-be3a-d5f85a602474">[{"state":1,"once":1988,"_errors":1990,"serverRendered":5,"path":11,"prerenderedAt":1992},["Reactive",2],{"$scolor-mode":3,"$sdd-pages":7,"$sdd-surrounds":1903,"$sdd-globals":1953,"$sdd-navigation":1955,"$sicons":1973,"$ssite-config":1984},{"preference":4,"value":4,"unknown":5,"forced":6},"system",true,false,["ShallowRef",8],["ShallowReactive",9],{"/articles/daisy-chaining-laravel-jobs":10},{"_path":11,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":14,"description":15,"layout":16,"publishAt":17,"ogImage":5,"body":18,"_type":1865,"_id":1866,"_source":1867,"_file":1868,"_extension":1869,"head":1870},"/articles/daisy-chaining-laravel-jobs","articles","","Daisy Chaining Laravel Jobs","We overcame Laravel Vapor timeout limits by implementing cursor pagination via daisy chaining jobs.","article","2024-06-08",{"type":19,"children":20,"toc":1860},"root",[21,55,75,82,109,155,183,312,325,346,651,661,667,672,685,690,708,721,1487,1492,1806,1811,1824,1830,1854],{"type":22,"tag":23,"props":24,"children":25},"element","p",{},[26,29,38,40,44,46,53],{"type":27,"value":28},"text","So at work we needed to add Laravel scout, we decided to go with ",{"type":22,"tag":30,"props":31,"children":35},"a",{"href":32,"rel":33},"https://typesense.org/",[34],"nofollow",[36],{"type":27,"value":37},"Typesense",{"type":27,"value":39},". ",{"type":22,"tag":41,"props":42,"children":43},"br",{},[],{"type":27,"value":45},"\nThis was fairly easy to set up, just follow the ",{"type":22,"tag":30,"props":47,"children":50},{"href":48,"rel":49},"https://laravel.com/docs/11.x/scout#typesense",[34],[51],{"type":27,"value":52},"docs",{"type":27,"value":54},".",{"type":22,"tag":56,"props":57,"children":58},"ul",{},[59,65,70],{"type":22,"tag":60,"props":61,"children":62},"li",{},[63],{"type":27,"value":64},"We tested locally, using a dockerized Typesense via Laravel Sail. Import worked, search worked! Easy! ‚úÖ",{"type":22,"tag":60,"props":66,"children":67},{},[68],{"type":27,"value":69},"We tested on staging, using Laravel Vapor. Import worked, search worked! Easy! ‚úÖ",{"type":22,"tag":60,"props":71,"children":72},{},[73],{"type":27,"value":74},"We deployed to production, using Laravel Vapor. Import... failed! ‚ùå üò±",{"type":22,"tag":76,"props":77,"children":79},"h2",{"id":78},"what-happened",[80],{"type":27,"value":81},"What happened?",{"type":22,"tag":23,"props":83,"children":84},{},[85,87,93,95,100,102,107],{"type":27,"value":86},"In local we tested using ",{"type":22,"tag":88,"props":89,"children":90},"u",{},[91],{"type":27,"value":92},"hundreds",{"type":27,"value":94}," of rows. In staging we tested using ",{"type":22,"tag":88,"props":96,"children":97},{},[98],{"type":27,"value":99},"thousands",{"type":27,"value":101}," of rows. But production had ",{"type":22,"tag":88,"props":103,"children":104},{},[105],{"type":27,"value":106},"millions",{"type":27,"value":108}," of rows!",{"type":22,"tag":23,"props":110,"children":111},{},[112,114,122,124,130,132,138,140,146,148,154],{"type":27,"value":113},"We ran ",{"type":22,"tag":115,"props":116,"children":119},"span",{"className":117},[118],"hl",[120],{"type":27,"value":121},"php artisan scout:import \"App\\Models\\Record\"",{"type":27,"value":123}," and it timed out. Ok maybe setting ",{"type":22,"tag":115,"props":125,"children":127},{"className":126},[118],[128],{"type":27,"value":129},"SCOUT_QUEUE",{"type":27,"value":131}," to ",{"type":22,"tag":115,"props":133,"children":135},{"className":134},[118],[136],{"type":27,"value":137},"true",{"type":27,"value":139}," is the only thing we need here. We changed it, redeployed, and reran the command; sadly it still timed out. Good news is we were seeing hundreds of jobs being processed, some of them successful and some failed. The errors were caused by ",{"type":22,"tag":115,"props":141,"children":143},{"className":142},[118],[144],{"type":27,"value":145},"exceeding maximum retries",{"type":27,"value":147}," and ",{"type":22,"tag":115,"props":149,"children":151},{"className":150},[118],[152],{"type":27,"value":153},"database connection issues",{"type":27,"value":54},{"type":22,"tag":23,"props":156,"children":157},{},[158,160,166,167,173,175,181],{"type":27,"value":159},"The model we were trying to import was using a view as its table so we reviewed the underlying query. We found out that it was inefficient because a couple of indexes were missing. We fixed the view and at the same time made a few Vapor config updates that we thought would help. We increased the ",{"type":22,"tag":115,"props":161,"children":163},{"className":162},[118],[164],{"type":27,"value":165},"queue-memory",{"type":27,"value":147},{"type":22,"tag":115,"props":168,"children":170},{"className":169},[118],[171],{"type":27,"value":172},"queue-timeout",{"type":27,"value":174},", reduced the ",{"type":22,"tag":115,"props":176,"children":178},{"className":177},[118],[179],{"type":27,"value":180},"queue-concurrency",{"type":27,"value":182}," value to avoid maxing out our database connections, and defined a dedicated queue so we can clear it by itself when we needed to.",{"type":22,"tag":184,"props":185,"children":189},"pre",{"className":186,"code":187,"language":188,"meta":13,"style":13},"language-yml shiki shiki-themes github-dark github-light","environments:\n  production:\n    queue-memory: 2048\n    queue-timeout: 300\n      queues:\n        - default-production\n        - scout-production: 50\n","yml",[190],{"type":22,"tag":191,"props":192,"children":193},"code",{"__ignoreMap":13},[194,211,224,244,262,275,290],{"type":22,"tag":115,"props":195,"children":198},{"class":196,"line":197},"line",1,[199,205],{"type":22,"tag":115,"props":200,"children":202},{"style":201},"--shiki-dark:#85E89D;--shiki-default:#22863A",[203],{"type":27,"value":204},"environments",{"type":22,"tag":115,"props":206,"children":208},{"style":207},"--shiki-dark:#E1E4E8;--shiki-default:#24292E",[209],{"type":27,"value":210},":\n",{"type":22,"tag":115,"props":212,"children":214},{"class":196,"line":213},2,[215,220],{"type":22,"tag":115,"props":216,"children":217},{"style":201},[218],{"type":27,"value":219},"  production",{"type":22,"tag":115,"props":221,"children":222},{"style":207},[223],{"type":27,"value":210},{"type":22,"tag":115,"props":225,"children":227},{"class":196,"line":226},3,[228,233,238],{"type":22,"tag":115,"props":229,"children":230},{"style":201},[231],{"type":27,"value":232},"    queue-memory",{"type":22,"tag":115,"props":234,"children":235},{"style":207},[236],{"type":27,"value":237},": ",{"type":22,"tag":115,"props":239,"children":241},{"style":240},"--shiki-dark:#79B8FF;--shiki-default:#005CC5",[242],{"type":27,"value":243},"2048\n",{"type":22,"tag":115,"props":245,"children":247},{"class":196,"line":246},4,[248,253,257],{"type":22,"tag":115,"props":249,"children":250},{"style":201},[251],{"type":27,"value":252},"    queue-timeout",{"type":22,"tag":115,"props":254,"children":255},{"style":207},[256],{"type":27,"value":237},{"type":22,"tag":115,"props":258,"children":259},{"style":240},[260],{"type":27,"value":261},"300\n",{"type":22,"tag":115,"props":263,"children":265},{"class":196,"line":264},5,[266,271],{"type":22,"tag":115,"props":267,"children":268},{"style":201},[269],{"type":27,"value":270},"      queues",{"type":22,"tag":115,"props":272,"children":273},{"style":207},[274],{"type":27,"value":210},{"type":22,"tag":115,"props":276,"children":278},{"class":196,"line":277},6,[279,284],{"type":22,"tag":115,"props":280,"children":281},{"style":207},[282],{"type":27,"value":283},"        - ",{"type":22,"tag":115,"props":285,"children":287},{"style":286},"--shiki-dark:#9ECBFF;--shiki-default:#032F62",[288],{"type":27,"value":289},"default-production\n",{"type":22,"tag":115,"props":291,"children":293},{"class":196,"line":292},7,[294,298,303,307],{"type":22,"tag":115,"props":295,"children":296},{"style":207},[297],{"type":27,"value":283},{"type":22,"tag":115,"props":299,"children":300},{"style":201},[301],{"type":27,"value":302},"scout-production",{"type":22,"tag":115,"props":304,"children":305},{"style":207},[306],{"type":27,"value":237},{"type":22,"tag":115,"props":308,"children":309},{"style":240},[310],{"type":27,"value":311},"50\n",{"type":22,"tag":23,"props":313,"children":314},{},[315,317,323],{"type":27,"value":316},"Ok, hopefully this does it. Again, we pushed the changes, redeployed, and reran the command. This time around the jobs were all successful but unfortunately the artisan command still timed out and couldn't complete the import. Not there yet but it's good progress, maybe increasing the ",{"type":22,"tag":115,"props":318,"children":320},{"className":319},[118],[321],{"type":27,"value":322},"cli-timeout",{"type":27,"value":324}," is all we need here. We implemented the change unfortunately the command still times out. What are we doing wrong?",{"type":22,"tag":23,"props":326,"children":327},{},[328,330,336,338,345],{"type":27,"value":329},"We found ourselves source diving the ",{"type":22,"tag":115,"props":331,"children":333},{"className":332},[118],[334],{"type":27,"value":335},"scout:import",{"type":27,"value":337}," command. And luckily we found the culprit for our issues. See ",{"type":22,"tag":30,"props":339,"children":342},{"href":340,"rel":341},"https://github.com/laravel/scout/blob/49d2be17c1ff59bc26867cfc8bdafff52aa3cdaa/src/SearchableScope.php#L34-L42",[34],[343],{"type":27,"value":344},"SearchableScope.php",{"type":27,"value":54},{"type":22,"tag":184,"props":347,"children":351},{"className":348,"code":349,"language":350,"meta":13,"style":13},"language-php shiki shiki-themes github-dark github-light","$builder->macro('searchable', function (EloquentBuilder $builder, $chunk = null) {\n    $scoutKeyName = $builder->getModel()->getScoutKeyName();\n\n    $builder->chunkById($chunk ?: config('scout.chunk.searchable', 500), function ($models) {\n        $models->filter->shouldBeSearchable()->searchable();\n\n        event(new ModelsImported($models));\n    }, $builder->qualifyColumn($scoutKeyName), $scoutKeyName);\n});\n","php",[352],{"type":22,"tag":191,"props":353,"children":354},{"__ignoreMap":13},[355,425,470,478,542,585,592,619,642],{"type":22,"tag":115,"props":356,"children":357},{"class":196,"line":197},[358,363,369,375,380,385,390,395,400,405,410,415,420],{"type":22,"tag":115,"props":359,"children":360},{"style":207},[361],{"type":27,"value":362},"$builder",{"type":22,"tag":115,"props":364,"children":366},{"style":365},"--shiki-dark:#F97583;--shiki-default:#D73A49",[367],{"type":27,"value":368},"->",{"type":22,"tag":115,"props":370,"children":372},{"style":371},"--shiki-dark:#B392F0;--shiki-default:#6F42C1",[373],{"type":27,"value":374},"macro",{"type":22,"tag":115,"props":376,"children":377},{"style":207},[378],{"type":27,"value":379},"(",{"type":22,"tag":115,"props":381,"children":382},{"style":286},[383],{"type":27,"value":384},"'searchable'",{"type":22,"tag":115,"props":386,"children":387},{"style":207},[388],{"type":27,"value":389},", ",{"type":22,"tag":115,"props":391,"children":392},{"style":365},[393],{"type":27,"value":394},"function",{"type":22,"tag":115,"props":396,"children":397},{"style":207},[398],{"type":27,"value":399}," (",{"type":22,"tag":115,"props":401,"children":402},{"style":240},[403],{"type":27,"value":404},"EloquentBuilder",{"type":22,"tag":115,"props":406,"children":407},{"style":207},[408],{"type":27,"value":409}," $builder, $chunk ",{"type":22,"tag":115,"props":411,"children":412},{"style":365},[413],{"type":27,"value":414},"=",{"type":22,"tag":115,"props":416,"children":417},{"style":240},[418],{"type":27,"value":419}," null",{"type":22,"tag":115,"props":421,"children":422},{"style":207},[423],{"type":27,"value":424},") {\n",{"type":22,"tag":115,"props":426,"children":427},{"class":196,"line":213},[428,433,437,442,446,451,456,460,465],{"type":22,"tag":115,"props":429,"children":430},{"style":207},[431],{"type":27,"value":432},"    $scoutKeyName ",{"type":22,"tag":115,"props":434,"children":435},{"style":365},[436],{"type":27,"value":414},{"type":22,"tag":115,"props":438,"children":439},{"style":207},[440],{"type":27,"value":441}," $builder",{"type":22,"tag":115,"props":443,"children":444},{"style":365},[445],{"type":27,"value":368},{"type":22,"tag":115,"props":447,"children":448},{"style":371},[449],{"type":27,"value":450},"getModel",{"type":22,"tag":115,"props":452,"children":453},{"style":207},[454],{"type":27,"value":455},"()",{"type":22,"tag":115,"props":457,"children":458},{"style":365},[459],{"type":27,"value":368},{"type":22,"tag":115,"props":461,"children":462},{"style":371},[463],{"type":27,"value":464},"getScoutKeyName",{"type":22,"tag":115,"props":466,"children":467},{"style":207},[468],{"type":27,"value":469},"();\n",{"type":22,"tag":115,"props":471,"children":472},{"class":196,"line":226},[473],{"type":22,"tag":115,"props":474,"children":475},{"emptyLinePlaceholder":5},[476],{"type":27,"value":477},"\n",{"type":22,"tag":115,"props":479,"children":480},{"class":196,"line":246},[481,486,490,495,500,505,510,514,519,523,528,533,537],{"type":22,"tag":115,"props":482,"children":483},{"style":207},[484],{"type":27,"value":485},"    $builder",{"type":22,"tag":115,"props":487,"children":488},{"style":365},[489],{"type":27,"value":368},{"type":22,"tag":115,"props":491,"children":492},{"style":371},[493],{"type":27,"value":494},"chunkById",{"type":22,"tag":115,"props":496,"children":497},{"style":207},[498],{"type":27,"value":499},"($chunk ",{"type":22,"tag":115,"props":501,"children":502},{"style":365},[503],{"type":27,"value":504},"?:",{"type":22,"tag":115,"props":506,"children":507},{"style":371},[508],{"type":27,"value":509}," config",{"type":22,"tag":115,"props":511,"children":512},{"style":207},[513],{"type":27,"value":379},{"type":22,"tag":115,"props":515,"children":516},{"style":286},[517],{"type":27,"value":518},"'scout.chunk.searchable'",{"type":22,"tag":115,"props":520,"children":521},{"style":207},[522],{"type":27,"value":389},{"type":22,"tag":115,"props":524,"children":525},{"style":240},[526],{"type":27,"value":527},"500",{"type":22,"tag":115,"props":529,"children":530},{"style":207},[531],{"type":27,"value":532},"), ",{"type":22,"tag":115,"props":534,"children":535},{"style":365},[536],{"type":27,"value":394},{"type":22,"tag":115,"props":538,"children":539},{"style":207},[540],{"type":27,"value":541}," ($models) {\n",{"type":22,"tag":115,"props":543,"children":544},{"class":196,"line":264},[545,550,554,559,563,568,572,576,581],{"type":22,"tag":115,"props":546,"children":547},{"style":207},[548],{"type":27,"value":549},"        $models",{"type":22,"tag":115,"props":551,"children":552},{"style":365},[553],{"type":27,"value":368},{"type":22,"tag":115,"props":555,"children":556},{"style":207},[557],{"type":27,"value":558},"filter",{"type":22,"tag":115,"props":560,"children":561},{"style":365},[562],{"type":27,"value":368},{"type":22,"tag":115,"props":564,"children":565},{"style":371},[566],{"type":27,"value":567},"shouldBeSearchable",{"type":22,"tag":115,"props":569,"children":570},{"style":207},[571],{"type":27,"value":455},{"type":22,"tag":115,"props":573,"children":574},{"style":365},[575],{"type":27,"value":368},{"type":22,"tag":115,"props":577,"children":578},{"style":371},[579],{"type":27,"value":580},"searchable",{"type":22,"tag":115,"props":582,"children":583},{"style":207},[584],{"type":27,"value":469},{"type":22,"tag":115,"props":586,"children":587},{"class":196,"line":277},[588],{"type":22,"tag":115,"props":589,"children":590},{"emptyLinePlaceholder":5},[591],{"type":27,"value":477},{"type":22,"tag":115,"props":593,"children":594},{"class":196,"line":292},[595,600,604,609,614],{"type":22,"tag":115,"props":596,"children":597},{"style":371},[598],{"type":27,"value":599},"        event",{"type":22,"tag":115,"props":601,"children":602},{"style":207},[603],{"type":27,"value":379},{"type":22,"tag":115,"props":605,"children":606},{"style":365},[607],{"type":27,"value":608},"new",{"type":22,"tag":115,"props":610,"children":611},{"style":240},[612],{"type":27,"value":613}," ModelsImported",{"type":22,"tag":115,"props":615,"children":616},{"style":207},[617],{"type":27,"value":618},"($models));\n",{"type":22,"tag":115,"props":620,"children":622},{"class":196,"line":621},8,[623,628,632,637],{"type":22,"tag":115,"props":624,"children":625},{"style":207},[626],{"type":27,"value":627},"    }, $builder",{"type":22,"tag":115,"props":629,"children":630},{"style":365},[631],{"type":27,"value":368},{"type":22,"tag":115,"props":633,"children":634},{"style":371},[635],{"type":27,"value":636},"qualifyColumn",{"type":22,"tag":115,"props":638,"children":639},{"style":207},[640],{"type":27,"value":641},"($scoutKeyName), $scoutKeyName);\n",{"type":22,"tag":115,"props":643,"children":645},{"class":196,"line":644},9,[646],{"type":22,"tag":115,"props":647,"children":648},{"style":207},[649],{"type":27,"value":650},"});\n",{"type":22,"tag":23,"props":652,"children":653},{},[654,659],{"type":22,"tag":115,"props":655,"children":657},{"className":656},[118],[658],{"type":27,"value":494},{"type":27,"value":660}," here works until it doesn't. Because chunk is just a loop, the more records you have the longer this loop will take. Unfortunately for us we were trying to import more than 2M rows, making us hit our Vapor CLI timeout.",{"type":22,"tag":76,"props":662,"children":664},{"id":663},"how-did-we-solve-it",[665],{"type":27,"value":666},"How did we solve it?",{"type":22,"tag":23,"props":668,"children":669},{},[670],{"type":27,"value":671},"So now that we know the issue, time to write a solution. What do we need?",{"type":22,"tag":56,"props":673,"children":674},{},[675,680],{"type":22,"tag":60,"props":676,"children":677},{},[678],{"type":27,"value":679},"A replacement command that can scale",{"type":22,"tag":60,"props":681,"children":682},{},[683],{"type":27,"value":684},"A job that performs the import through a queue",{"type":22,"tag":23,"props":686,"children":687},{},[688],{"type":27,"value":689},"What do we need to consider?",{"type":22,"tag":56,"props":691,"children":692},{},[693,698,703],{"type":22,"tag":60,"props":694,"children":695},{},[696],{"type":27,"value":697},"CLI timeout",{"type":22,"tag":60,"props":699,"children":700},{},[701],{"type":27,"value":702},"Queue timeout",{"type":22,"tag":60,"props":704,"children":705},{},[706],{"type":27,"value":707},"Throttling",{"type":22,"tag":23,"props":709,"children":710},{},[711,713,719],{"type":27,"value":712},"The solution we came up with is ",{"type":22,"tag":115,"props":714,"children":716},{"className":715},[118],[717],{"type":27,"value":718},"daisy chaining jobs",{"type":27,"value":720},". We can accomplish daisy chaining simply by dispatching another instance of the same job within the job itself. To avoid infinite loop we have to make sure we have an exit logic in place. For our case here it stops dispatching a new job when it's at the end of the table.",{"type":22,"tag":184,"props":722,"children":724},{"className":348,"code":723,"language":350,"meta":13,"style":13},"class MakeModelSearchable implements ShouldQueue\n{\n    public function __construct(\n        public string $class,\n        public int|string|null $cursor = null,\n        public int $chunk = 500\n    ) {\n    }\n\n    public function handle(): void\n    {\n        /** @var Model $model */\n        $model = new ($this->class);\n\n        // CURSOR BASED PAGINATION\n        $keys = $model::query()\n            ->limit($this->chunk)\n            ->when($this->cursor !== null, function(Builder $q){\n              return $q->where($model->getKeyName(), '>', $this->cursor);\n            })\n            ->pluck($model->getKeyName());\n\n        // THIS IS OUR EXIT LOGIC\n        if($keys->isEmpty()) {\n            return;\n        }\n\n        // CALL SCOUT'S SEARCHABLE METHOD TO PERFORM THE IMPORT\n        $model::query()\n          ->whereIn($model->getKeyName(), $keys)\n          ->searchable();\n\n        // WE DISPATCH ANOTHER JOB WITH A NEW CURSOR\n        static::dispatch($this->class, $keys->last(), $this->chunk);\n    }\n}\n",[725],{"type":22,"tag":191,"props":726,"children":727},{"__ignoreMap":13},[728,751,759,782,800,849,874,882,890,897,928,937,962,998,1006,1015,1048,1079,1140,1204,1213,1243,1251,1260,1288,1302,1311,1319,1328,1349,1380,1396,1404,1413,1470,1478],{"type":22,"tag":115,"props":729,"children":730},{"class":196,"line":197},[731,736,741,746],{"type":22,"tag":115,"props":732,"children":733},{"style":365},[734],{"type":27,"value":735},"class",{"type":22,"tag":115,"props":737,"children":738},{"style":371},[739],{"type":27,"value":740}," MakeModelSearchable",{"type":22,"tag":115,"props":742,"children":743},{"style":365},[744],{"type":27,"value":745}," implements",{"type":22,"tag":115,"props":747,"children":748},{"style":371},[749],{"type":27,"value":750}," ShouldQueue\n",{"type":22,"tag":115,"props":752,"children":753},{"class":196,"line":213},[754],{"type":22,"tag":115,"props":755,"children":756},{"style":207},[757],{"type":27,"value":758},"{\n",{"type":22,"tag":115,"props":760,"children":761},{"class":196,"line":226},[762,767,772,777],{"type":22,"tag":115,"props":763,"children":764},{"style":365},[765],{"type":27,"value":766},"    public",{"type":22,"tag":115,"props":768,"children":769},{"style":365},[770],{"type":27,"value":771}," function",{"type":22,"tag":115,"props":773,"children":774},{"style":240},[775],{"type":27,"value":776}," __construct",{"type":22,"tag":115,"props":778,"children":779},{"style":207},[780],{"type":27,"value":781},"(\n",{"type":22,"tag":115,"props":783,"children":784},{"class":196,"line":246},[785,790,795],{"type":22,"tag":115,"props":786,"children":787},{"style":365},[788],{"type":27,"value":789},"        public",{"type":22,"tag":115,"props":791,"children":792},{"style":365},[793],{"type":27,"value":794}," string",{"type":22,"tag":115,"props":796,"children":797},{"style":207},[798],{"type":27,"value":799}," $class,\n",{"type":22,"tag":115,"props":801,"children":802},{"class":196,"line":264},[803,807,812,817,822,826,831,836,840,844],{"type":22,"tag":115,"props":804,"children":805},{"style":365},[806],{"type":27,"value":789},{"type":22,"tag":115,"props":808,"children":809},{"style":365},[810],{"type":27,"value":811}," int",{"type":22,"tag":115,"props":813,"children":814},{"style":207},[815],{"type":27,"value":816},"|",{"type":22,"tag":115,"props":818,"children":819},{"style":365},[820],{"type":27,"value":821},"string",{"type":22,"tag":115,"props":823,"children":824},{"style":207},[825],{"type":27,"value":816},{"type":22,"tag":115,"props":827,"children":828},{"style":365},[829],{"type":27,"value":830},"null",{"type":22,"tag":115,"props":832,"children":833},{"style":207},[834],{"type":27,"value":835}," $cursor ",{"type":22,"tag":115,"props":837,"children":838},{"style":365},[839],{"type":27,"value":414},{"type":22,"tag":115,"props":841,"children":842},{"style":240},[843],{"type":27,"value":419},{"type":22,"tag":115,"props":845,"children":846},{"style":207},[847],{"type":27,"value":848},",\n",{"type":22,"tag":115,"props":850,"children":851},{"class":196,"line":277},[852,856,860,865,869],{"type":22,"tag":115,"props":853,"children":854},{"style":365},[855],{"type":27,"value":789},{"type":22,"tag":115,"props":857,"children":858},{"style":365},[859],{"type":27,"value":811},{"type":22,"tag":115,"props":861,"children":862},{"style":207},[863],{"type":27,"value":864}," $chunk ",{"type":22,"tag":115,"props":866,"children":867},{"style":365},[868],{"type":27,"value":414},{"type":22,"tag":115,"props":870,"children":871},{"style":240},[872],{"type":27,"value":873}," 500\n",{"type":22,"tag":115,"props":875,"children":876},{"class":196,"line":292},[877],{"type":22,"tag":115,"props":878,"children":879},{"style":207},[880],{"type":27,"value":881},"    ) {\n",{"type":22,"tag":115,"props":883,"children":884},{"class":196,"line":621},[885],{"type":22,"tag":115,"props":886,"children":887},{"style":207},[888],{"type":27,"value":889},"    }\n",{"type":22,"tag":115,"props":891,"children":892},{"class":196,"line":644},[893],{"type":22,"tag":115,"props":894,"children":895},{"emptyLinePlaceholder":5},[896],{"type":27,"value":477},{"type":22,"tag":115,"props":898,"children":900},{"class":196,"line":899},10,[901,905,909,914,918,923],{"type":22,"tag":115,"props":902,"children":903},{"style":365},[904],{"type":27,"value":766},{"type":22,"tag":115,"props":906,"children":907},{"style":365},[908],{"type":27,"value":771},{"type":22,"tag":115,"props":910,"children":911},{"style":371},[912],{"type":27,"value":913}," handle",{"type":22,"tag":115,"props":915,"children":916},{"style":207},[917],{"type":27,"value":455},{"type":22,"tag":115,"props":919,"children":920},{"style":365},[921],{"type":27,"value":922},":",{"type":22,"tag":115,"props":924,"children":925},{"style":365},[926],{"type":27,"value":927}," void\n",{"type":22,"tag":115,"props":929,"children":931},{"class":196,"line":930},11,[932],{"type":22,"tag":115,"props":933,"children":934},{"style":207},[935],{"type":27,"value":936},"    {\n",{"type":22,"tag":115,"props":938,"children":940},{"class":196,"line":939},12,[941,947,952,957],{"type":22,"tag":115,"props":942,"children":944},{"style":943},"--shiki-dark:#6A737D;--shiki-default:#6A737D",[945],{"type":27,"value":946},"        /** ",{"type":22,"tag":115,"props":948,"children":949},{"style":365},[950],{"type":27,"value":951},"@var",{"type":22,"tag":115,"props":953,"children":954},{"style":240},[955],{"type":27,"value":956}," Model",{"type":22,"tag":115,"props":958,"children":959},{"style":943},[960],{"type":27,"value":961}," $model */\n",{"type":22,"tag":115,"props":963,"children":965},{"class":196,"line":964},13,[966,971,975,980,984,989,993],{"type":22,"tag":115,"props":967,"children":968},{"style":207},[969],{"type":27,"value":970},"        $model ",{"type":22,"tag":115,"props":972,"children":973},{"style":365},[974],{"type":27,"value":414},{"type":22,"tag":115,"props":976,"children":977},{"style":371},[978],{"type":27,"value":979}," new",{"type":22,"tag":115,"props":981,"children":982},{"style":207},[983],{"type":27,"value":399},{"type":22,"tag":115,"props":985,"children":986},{"style":240},[987],{"type":27,"value":988},"$this",{"type":22,"tag":115,"props":990,"children":991},{"style":365},[992],{"type":27,"value":368},{"type":22,"tag":115,"props":994,"children":995},{"style":207},[996],{"type":27,"value":997},"class);\n",{"type":22,"tag":115,"props":999,"children":1001},{"class":196,"line":1000},14,[1002],{"type":22,"tag":115,"props":1003,"children":1004},{"emptyLinePlaceholder":5},[1005],{"type":27,"value":477},{"type":22,"tag":115,"props":1007,"children":1009},{"class":196,"line":1008},15,[1010],{"type":22,"tag":115,"props":1011,"children":1012},{"style":943},[1013],{"type":27,"value":1014},"        // CURSOR BASED PAGINATION\n",{"type":22,"tag":115,"props":1016,"children":1018},{"class":196,"line":1017},16,[1019,1024,1028,1033,1038,1043],{"type":22,"tag":115,"props":1020,"children":1021},{"style":207},[1022],{"type":27,"value":1023},"        $keys ",{"type":22,"tag":115,"props":1025,"children":1026},{"style":365},[1027],{"type":27,"value":414},{"type":22,"tag":115,"props":1029,"children":1030},{"style":207},[1031],{"type":27,"value":1032}," $model",{"type":22,"tag":115,"props":1034,"children":1035},{"style":365},[1036],{"type":27,"value":1037},"::",{"type":22,"tag":115,"props":1039,"children":1040},{"style":371},[1041],{"type":27,"value":1042},"query",{"type":22,"tag":115,"props":1044,"children":1045},{"style":207},[1046],{"type":27,"value":1047},"()\n",{"type":22,"tag":115,"props":1049,"children":1051},{"class":196,"line":1050},17,[1052,1057,1062,1066,1070,1074],{"type":22,"tag":115,"props":1053,"children":1054},{"style":365},[1055],{"type":27,"value":1056},"            ->",{"type":22,"tag":115,"props":1058,"children":1059},{"style":371},[1060],{"type":27,"value":1061},"limit",{"type":22,"tag":115,"props":1063,"children":1064},{"style":207},[1065],{"type":27,"value":379},{"type":22,"tag":115,"props":1067,"children":1068},{"style":240},[1069],{"type":27,"value":988},{"type":22,"tag":115,"props":1071,"children":1072},{"style":365},[1073],{"type":27,"value":368},{"type":22,"tag":115,"props":1075,"children":1076},{"style":207},[1077],{"type":27,"value":1078},"chunk)\n",{"type":22,"tag":115,"props":1080,"children":1082},{"class":196,"line":1081},18,[1083,1087,1092,1096,1100,1104,1109,1114,1118,1122,1126,1130,1135],{"type":22,"tag":115,"props":1084,"children":1085},{"style":365},[1086],{"type":27,"value":1056},{"type":22,"tag":115,"props":1088,"children":1089},{"style":371},[1090],{"type":27,"value":1091},"when",{"type":22,"tag":115,"props":1093,"children":1094},{"style":207},[1095],{"type":27,"value":379},{"type":22,"tag":115,"props":1097,"children":1098},{"style":240},[1099],{"type":27,"value":988},{"type":22,"tag":115,"props":1101,"children":1102},{"style":365},[1103],{"type":27,"value":368},{"type":22,"tag":115,"props":1105,"children":1106},{"style":207},[1107],{"type":27,"value":1108},"cursor ",{"type":22,"tag":115,"props":1110,"children":1111},{"style":365},[1112],{"type":27,"value":1113},"!==",{"type":22,"tag":115,"props":1115,"children":1116},{"style":240},[1117],{"type":27,"value":419},{"type":22,"tag":115,"props":1119,"children":1120},{"style":207},[1121],{"type":27,"value":389},{"type":22,"tag":115,"props":1123,"children":1124},{"style":365},[1125],{"type":27,"value":394},{"type":22,"tag":115,"props":1127,"children":1128},{"style":207},[1129],{"type":27,"value":379},{"type":22,"tag":115,"props":1131,"children":1132},{"style":240},[1133],{"type":27,"value":1134},"Builder",{"type":22,"tag":115,"props":1136,"children":1137},{"style":207},[1138],{"type":27,"value":1139}," $q){\n",{"type":22,"tag":115,"props":1141,"children":1143},{"class":196,"line":1142},19,[1144,1149,1154,1158,1163,1168,1172,1177,1182,1187,1191,1195,1199],{"type":22,"tag":115,"props":1145,"children":1146},{"style":365},[1147],{"type":27,"value":1148},"              return",{"type":22,"tag":115,"props":1150,"children":1151},{"style":207},[1152],{"type":27,"value":1153}," $q",{"type":22,"tag":115,"props":1155,"children":1156},{"style":365},[1157],{"type":27,"value":368},{"type":22,"tag":115,"props":1159,"children":1160},{"style":371},[1161],{"type":27,"value":1162},"where",{"type":22,"tag":115,"props":1164,"children":1165},{"style":207},[1166],{"type":27,"value":1167},"($model",{"type":22,"tag":115,"props":1169,"children":1170},{"style":365},[1171],{"type":27,"value":368},{"type":22,"tag":115,"props":1173,"children":1174},{"style":371},[1175],{"type":27,"value":1176},"getKeyName",{"type":22,"tag":115,"props":1178,"children":1179},{"style":207},[1180],{"type":27,"value":1181},"(), ",{"type":22,"tag":115,"props":1183,"children":1184},{"style":286},[1185],{"type":27,"value":1186},"'>'",{"type":22,"tag":115,"props":1188,"children":1189},{"style":207},[1190],{"type":27,"value":389},{"type":22,"tag":115,"props":1192,"children":1193},{"style":240},[1194],{"type":27,"value":988},{"type":22,"tag":115,"props":1196,"children":1197},{"style":365},[1198],{"type":27,"value":368},{"type":22,"tag":115,"props":1200,"children":1201},{"style":207},[1202],{"type":27,"value":1203},"cursor);\n",{"type":22,"tag":115,"props":1205,"children":1207},{"class":196,"line":1206},20,[1208],{"type":22,"tag":115,"props":1209,"children":1210},{"style":207},[1211],{"type":27,"value":1212},"            })\n",{"type":22,"tag":115,"props":1214,"children":1216},{"class":196,"line":1215},21,[1217,1221,1226,1230,1234,1238],{"type":22,"tag":115,"props":1218,"children":1219},{"style":365},[1220],{"type":27,"value":1056},{"type":22,"tag":115,"props":1222,"children":1223},{"style":371},[1224],{"type":27,"value":1225},"pluck",{"type":22,"tag":115,"props":1227,"children":1228},{"style":207},[1229],{"type":27,"value":1167},{"type":22,"tag":115,"props":1231,"children":1232},{"style":365},[1233],{"type":27,"value":368},{"type":22,"tag":115,"props":1235,"children":1236},{"style":371},[1237],{"type":27,"value":1176},{"type":22,"tag":115,"props":1239,"children":1240},{"style":207},[1241],{"type":27,"value":1242},"());\n",{"type":22,"tag":115,"props":1244,"children":1246},{"class":196,"line":1245},22,[1247],{"type":22,"tag":115,"props":1248,"children":1249},{"emptyLinePlaceholder":5},[1250],{"type":27,"value":477},{"type":22,"tag":115,"props":1252,"children":1254},{"class":196,"line":1253},23,[1255],{"type":22,"tag":115,"props":1256,"children":1257},{"style":943},[1258],{"type":27,"value":1259},"        // THIS IS OUR EXIT LOGIC\n",{"type":22,"tag":115,"props":1261,"children":1263},{"class":196,"line":1262},24,[1264,1269,1274,1278,1283],{"type":22,"tag":115,"props":1265,"children":1266},{"style":365},[1267],{"type":27,"value":1268},"        if",{"type":22,"tag":115,"props":1270,"children":1271},{"style":207},[1272],{"type":27,"value":1273},"($keys",{"type":22,"tag":115,"props":1275,"children":1276},{"style":365},[1277],{"type":27,"value":368},{"type":22,"tag":115,"props":1279,"children":1280},{"style":371},[1281],{"type":27,"value":1282},"isEmpty",{"type":22,"tag":115,"props":1284,"children":1285},{"style":207},[1286],{"type":27,"value":1287},"()) {\n",{"type":22,"tag":115,"props":1289,"children":1291},{"class":196,"line":1290},25,[1292,1297],{"type":22,"tag":115,"props":1293,"children":1294},{"style":365},[1295],{"type":27,"value":1296},"            return",{"type":22,"tag":115,"props":1298,"children":1299},{"style":207},[1300],{"type":27,"value":1301},";\n",{"type":22,"tag":115,"props":1303,"children":1305},{"class":196,"line":1304},26,[1306],{"type":22,"tag":115,"props":1307,"children":1308},{"style":207},[1309],{"type":27,"value":1310},"        }\n",{"type":22,"tag":115,"props":1312,"children":1314},{"class":196,"line":1313},27,[1315],{"type":22,"tag":115,"props":1316,"children":1317},{"emptyLinePlaceholder":5},[1318],{"type":27,"value":477},{"type":22,"tag":115,"props":1320,"children":1322},{"class":196,"line":1321},28,[1323],{"type":22,"tag":115,"props":1324,"children":1325},{"style":943},[1326],{"type":27,"value":1327},"        // CALL SCOUT'S SEARCHABLE METHOD TO PERFORM THE IMPORT\n",{"type":22,"tag":115,"props":1329,"children":1331},{"class":196,"line":1330},29,[1332,1337,1341,1345],{"type":22,"tag":115,"props":1333,"children":1334},{"style":207},[1335],{"type":27,"value":1336},"        $model",{"type":22,"tag":115,"props":1338,"children":1339},{"style":365},[1340],{"type":27,"value":1037},{"type":22,"tag":115,"props":1342,"children":1343},{"style":371},[1344],{"type":27,"value":1042},{"type":22,"tag":115,"props":1346,"children":1347},{"style":207},[1348],{"type":27,"value":1047},{"type":22,"tag":115,"props":1350,"children":1352},{"class":196,"line":1351},30,[1353,1358,1363,1367,1371,1375],{"type":22,"tag":115,"props":1354,"children":1355},{"style":365},[1356],{"type":27,"value":1357},"          ->",{"type":22,"tag":115,"props":1359,"children":1360},{"style":371},[1361],{"type":27,"value":1362},"whereIn",{"type":22,"tag":115,"props":1364,"children":1365},{"style":207},[1366],{"type":27,"value":1167},{"type":22,"tag":115,"props":1368,"children":1369},{"style":365},[1370],{"type":27,"value":368},{"type":22,"tag":115,"props":1372,"children":1373},{"style":371},[1374],{"type":27,"value":1176},{"type":22,"tag":115,"props":1376,"children":1377},{"style":207},[1378],{"type":27,"value":1379},"(), $keys)\n",{"type":22,"tag":115,"props":1381,"children":1383},{"class":196,"line":1382},31,[1384,1388,1392],{"type":22,"tag":115,"props":1385,"children":1386},{"style":365},[1387],{"type":27,"value":1357},{"type":22,"tag":115,"props":1389,"children":1390},{"style":371},[1391],{"type":27,"value":580},{"type":22,"tag":115,"props":1393,"children":1394},{"style":207},[1395],{"type":27,"value":469},{"type":22,"tag":115,"props":1397,"children":1399},{"class":196,"line":1398},32,[1400],{"type":22,"tag":115,"props":1401,"children":1402},{"emptyLinePlaceholder":5},[1403],{"type":27,"value":477},{"type":22,"tag":115,"props":1405,"children":1407},{"class":196,"line":1406},33,[1408],{"type":22,"tag":115,"props":1409,"children":1410},{"style":943},[1411],{"type":27,"value":1412},"        // WE DISPATCH ANOTHER JOB WITH A NEW CURSOR\n",{"type":22,"tag":115,"props":1414,"children":1416},{"class":196,"line":1415},34,[1417,1422,1427,1431,1435,1439,1444,1448,1453,1457,1461,1465],{"type":22,"tag":115,"props":1418,"children":1419},{"style":365},[1420],{"type":27,"value":1421},"        static::",{"type":22,"tag":115,"props":1423,"children":1424},{"style":371},[1425],{"type":27,"value":1426},"dispatch",{"type":22,"tag":115,"props":1428,"children":1429},{"style":207},[1430],{"type":27,"value":379},{"type":22,"tag":115,"props":1432,"children":1433},{"style":240},[1434],{"type":27,"value":988},{"type":22,"tag":115,"props":1436,"children":1437},{"style":365},[1438],{"type":27,"value":368},{"type":22,"tag":115,"props":1440,"children":1441},{"style":207},[1442],{"type":27,"value":1443},"class, $keys",{"type":22,"tag":115,"props":1445,"children":1446},{"style":365},[1447],{"type":27,"value":368},{"type":22,"tag":115,"props":1449,"children":1450},{"style":371},[1451],{"type":27,"value":1452},"last",{"type":22,"tag":115,"props":1454,"children":1455},{"style":207},[1456],{"type":27,"value":1181},{"type":22,"tag":115,"props":1458,"children":1459},{"style":240},[1460],{"type":27,"value":988},{"type":22,"tag":115,"props":1462,"children":1463},{"style":365},[1464],{"type":27,"value":368},{"type":22,"tag":115,"props":1466,"children":1467},{"style":207},[1468],{"type":27,"value":1469},"chunk);\n",{"type":22,"tag":115,"props":1471,"children":1473},{"class":196,"line":1472},35,[1474],{"type":22,"tag":115,"props":1475,"children":1476},{"style":207},[1477],{"type":27,"value":889},{"type":22,"tag":115,"props":1479,"children":1481},{"class":196,"line":1480},36,[1482],{"type":22,"tag":115,"props":1483,"children":1484},{"style":207},[1485],{"type":27,"value":1486},"}\n",{"type":22,"tag":23,"props":1488,"children":1489},{},[1490],{"type":27,"value":1491},"We start the import process with a command that dispatches the first job.",{"type":22,"tag":184,"props":1493,"children":1495},{"className":348,"code":1494,"language":350,"meta":13,"style":13},"class ImportScoutModel extends Command\n{\n    protected $signature = 'app:import-scout-model\n            {model : Class name of model to bulk import}\n            {--c|chunk= : The number of records to import at a time (Defaults to configuration value: `scout.chunk.searchable`)}';\n\n    public function handle(): int\n    {\n        $class = $this->argument('model');\n\n        $chunk = $this->option('chunk') ?? config('scout.chunk.searchable');\n\n        MakeModelSearchable::dispatch($class, null, $chunk);\n\n        return self::SUCCESS;\n    }\n\n}\n",[1496],{"type":22,"tag":191,"props":1497,"children":1498},{"__ignoreMap":13},[1499,1521,1528,1550,1558,1570,1577,1605,1612,1652,1659,1719,1726,1756,1763,1785,1792,1799],{"type":22,"tag":115,"props":1500,"children":1501},{"class":196,"line":197},[1502,1506,1511,1516],{"type":22,"tag":115,"props":1503,"children":1504},{"style":365},[1505],{"type":27,"value":735},{"type":22,"tag":115,"props":1507,"children":1508},{"style":371},[1509],{"type":27,"value":1510}," ImportScoutModel",{"type":22,"tag":115,"props":1512,"children":1513},{"style":365},[1514],{"type":27,"value":1515}," extends",{"type":22,"tag":115,"props":1517,"children":1518},{"style":371},[1519],{"type":27,"value":1520}," Command\n",{"type":22,"tag":115,"props":1522,"children":1523},{"class":196,"line":213},[1524],{"type":22,"tag":115,"props":1525,"children":1526},{"style":207},[1527],{"type":27,"value":758},{"type":22,"tag":115,"props":1529,"children":1530},{"class":196,"line":226},[1531,1536,1541,1545],{"type":22,"tag":115,"props":1532,"children":1533},{"style":365},[1534],{"type":27,"value":1535},"    protected",{"type":22,"tag":115,"props":1537,"children":1538},{"style":207},[1539],{"type":27,"value":1540}," $signature ",{"type":22,"tag":115,"props":1542,"children":1543},{"style":365},[1544],{"type":27,"value":414},{"type":22,"tag":115,"props":1546,"children":1547},{"style":286},[1548],{"type":27,"value":1549}," 'app:import-scout-model\n",{"type":22,"tag":115,"props":1551,"children":1552},{"class":196,"line":246},[1553],{"type":22,"tag":115,"props":1554,"children":1555},{"style":286},[1556],{"type":27,"value":1557},"            {model : Class name of model to bulk import}\n",{"type":22,"tag":115,"props":1559,"children":1560},{"class":196,"line":264},[1561,1566],{"type":22,"tag":115,"props":1562,"children":1563},{"style":286},[1564],{"type":27,"value":1565},"            {--c|chunk= : The number of records to import at a time (Defaults to configuration value: `scout.chunk.searchable`)}'",{"type":22,"tag":115,"props":1567,"children":1568},{"style":207},[1569],{"type":27,"value":1301},{"type":22,"tag":115,"props":1571,"children":1572},{"class":196,"line":277},[1573],{"type":22,"tag":115,"props":1574,"children":1575},{"emptyLinePlaceholder":5},[1576],{"type":27,"value":477},{"type":22,"tag":115,"props":1578,"children":1579},{"class":196,"line":292},[1580,1584,1588,1592,1596,1600],{"type":22,"tag":115,"props":1581,"children":1582},{"style":365},[1583],{"type":27,"value":766},{"type":22,"tag":115,"props":1585,"children":1586},{"style":365},[1587],{"type":27,"value":771},{"type":22,"tag":115,"props":1589,"children":1590},{"style":371},[1591],{"type":27,"value":913},{"type":22,"tag":115,"props":1593,"children":1594},{"style":207},[1595],{"type":27,"value":455},{"type":22,"tag":115,"props":1597,"children":1598},{"style":365},[1599],{"type":27,"value":922},{"type":22,"tag":115,"props":1601,"children":1602},{"style":365},[1603],{"type":27,"value":1604}," int\n",{"type":22,"tag":115,"props":1606,"children":1607},{"class":196,"line":621},[1608],{"type":22,"tag":115,"props":1609,"children":1610},{"style":207},[1611],{"type":27,"value":936},{"type":22,"tag":115,"props":1613,"children":1614},{"class":196,"line":644},[1615,1620,1624,1629,1633,1638,1642,1647],{"type":22,"tag":115,"props":1616,"children":1617},{"style":207},[1618],{"type":27,"value":1619},"        $class ",{"type":22,"tag":115,"props":1621,"children":1622},{"style":365},[1623],{"type":27,"value":414},{"type":22,"tag":115,"props":1625,"children":1626},{"style":240},[1627],{"type":27,"value":1628}," $this",{"type":22,"tag":115,"props":1630,"children":1631},{"style":365},[1632],{"type":27,"value":368},{"type":22,"tag":115,"props":1634,"children":1635},{"style":371},[1636],{"type":27,"value":1637},"argument",{"type":22,"tag":115,"props":1639,"children":1640},{"style":207},[1641],{"type":27,"value":379},{"type":22,"tag":115,"props":1643,"children":1644},{"style":286},[1645],{"type":27,"value":1646},"'model'",{"type":22,"tag":115,"props":1648,"children":1649},{"style":207},[1650],{"type":27,"value":1651},");\n",{"type":22,"tag":115,"props":1653,"children":1654},{"class":196,"line":899},[1655],{"type":22,"tag":115,"props":1656,"children":1657},{"emptyLinePlaceholder":5},[1658],{"type":27,"value":477},{"type":22,"tag":115,"props":1660,"children":1661},{"class":196,"line":930},[1662,1667,1671,1675,1679,1684,1688,1693,1698,1703,1707,1711,1715],{"type":22,"tag":115,"props":1663,"children":1664},{"style":207},[1665],{"type":27,"value":1666},"        $chunk ",{"type":22,"tag":115,"props":1668,"children":1669},{"style":365},[1670],{"type":27,"value":414},{"type":22,"tag":115,"props":1672,"children":1673},{"style":240},[1674],{"type":27,"value":1628},{"type":22,"tag":115,"props":1676,"children":1677},{"style":365},[1678],{"type":27,"value":368},{"type":22,"tag":115,"props":1680,"children":1681},{"style":371},[1682],{"type":27,"value":1683},"option",{"type":22,"tag":115,"props":1685,"children":1686},{"style":207},[1687],{"type":27,"value":379},{"type":22,"tag":115,"props":1689,"children":1690},{"style":286},[1691],{"type":27,"value":1692},"'chunk'",{"type":22,"tag":115,"props":1694,"children":1695},{"style":207},[1696],{"type":27,"value":1697},") ",{"type":22,"tag":115,"props":1699,"children":1700},{"style":365},[1701],{"type":27,"value":1702},"??",{"type":22,"tag":115,"props":1704,"children":1705},{"style":371},[1706],{"type":27,"value":509},{"type":22,"tag":115,"props":1708,"children":1709},{"style":207},[1710],{"type":27,"value":379},{"type":22,"tag":115,"props":1712,"children":1713},{"style":286},[1714],{"type":27,"value":518},{"type":22,"tag":115,"props":1716,"children":1717},{"style":207},[1718],{"type":27,"value":1651},{"type":22,"tag":115,"props":1720,"children":1721},{"class":196,"line":939},[1722],{"type":22,"tag":115,"props":1723,"children":1724},{"emptyLinePlaceholder":5},[1725],{"type":27,"value":477},{"type":22,"tag":115,"props":1727,"children":1728},{"class":196,"line":964},[1729,1734,1738,1742,1747,1751],{"type":22,"tag":115,"props":1730,"children":1731},{"style":240},[1732],{"type":27,"value":1733},"        MakeModelSearchable",{"type":22,"tag":115,"props":1735,"children":1736},{"style":365},[1737],{"type":27,"value":1037},{"type":22,"tag":115,"props":1739,"children":1740},{"style":371},[1741],{"type":27,"value":1426},{"type":22,"tag":115,"props":1743,"children":1744},{"style":207},[1745],{"type":27,"value":1746},"($class, ",{"type":22,"tag":115,"props":1748,"children":1749},{"style":240},[1750],{"type":27,"value":830},{"type":22,"tag":115,"props":1752,"children":1753},{"style":207},[1754],{"type":27,"value":1755},", $chunk);\n",{"type":22,"tag":115,"props":1757,"children":1758},{"class":196,"line":1000},[1759],{"type":22,"tag":115,"props":1760,"children":1761},{"emptyLinePlaceholder":5},[1762],{"type":27,"value":477},{"type":22,"tag":115,"props":1764,"children":1765},{"class":196,"line":1008},[1766,1771,1776,1781],{"type":22,"tag":115,"props":1767,"children":1768},{"style":365},[1769],{"type":27,"value":1770},"        return",{"type":22,"tag":115,"props":1772,"children":1773},{"style":365},[1774],{"type":27,"value":1775}," self::",{"type":22,"tag":115,"props":1777,"children":1778},{"style":240},[1779],{"type":27,"value":1780},"SUCCESS",{"type":22,"tag":115,"props":1782,"children":1783},{"style":207},[1784],{"type":27,"value":1301},{"type":22,"tag":115,"props":1786,"children":1787},{"class":196,"line":1017},[1788],{"type":22,"tag":115,"props":1789,"children":1790},{"style":207},[1791],{"type":27,"value":889},{"type":22,"tag":115,"props":1793,"children":1794},{"class":196,"line":1050},[1795],{"type":22,"tag":115,"props":1796,"children":1797},{"emptyLinePlaceholder":5},[1798],{"type":27,"value":477},{"type":22,"tag":115,"props":1800,"children":1801},{"class":196,"line":1081},[1802],{"type":22,"tag":115,"props":1803,"children":1804},{"style":207},[1805],{"type":27,"value":1486},{"type":22,"tag":23,"props":1807,"children":1808},{},[1809],{"type":27,"value":1810},"With this approach we are able to address the CLI timeout because it's only responsible for dispatching the first job. Queue timeout was already addressed by optimizing our queries. Throttling issues can easily be addressed by tweaking our job class' backoff strategy.",{"type":22,"tag":23,"props":1812,"children":1813},{},[1814,1816,1823],{"type":27,"value":1815},"This solution is inspired by ",{"type":22,"tag":30,"props":1817,"children":1820},{"href":1818,"rel":1819},"https://planetscale.com/learn/courses/mysql-for-developers/examples/cursor-pagination",[34],[1821],{"type":27,"value":1822},"Aaron Francis' cursor pagination lesson",{"type":27,"value":54},{"type":22,"tag":76,"props":1825,"children":1827},{"id":1826},"lessons-learned-along-the-way",[1828],{"type":27,"value":1829},"Lessons learned along the way",{"type":22,"tag":56,"props":1831,"children":1832},{},[1833],{"type":22,"tag":60,"props":1834,"children":1835},{},[1836,1838,1844,1846,1852],{"type":27,"value":1837},"When pairing Laravel Scout with Typesense and queue is set to true, be sure to restart your queue after running a ",{"type":22,"tag":115,"props":1839,"children":1841},{"className":1840},[118],[1842],{"type":27,"value":1843},"scout:flush",{"type":27,"value":1845}," You're gonna get a ",{"type":22,"tag":115,"props":1847,"children":1849},{"className":1848},[118],[1850],{"type":27,"value":1851},"Typesense\\Exceptions\\ObjectNotFound",{"type":27,"value":1853}," exception if you do an import without restarting.",{"type":22,"tag":1855,"props":1856,"children":1857},"style",{},[1858],{"type":27,"value":1859},"html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}",{"title":13,"searchDepth":213,"depth":213,"links":1861},[1862,1863,1864],{"id":78,"depth":213,"text":81},{"id":663,"depth":213,"text":666},{"id":1826,"depth":213,"text":1829},"markdown","content:2.articles:daisy-chaining-laravel-jobs.md","content","2.articles/daisy-chaining-laravel-jobs.md","md",{"script":1871,"meta":1877},[1872],{"id":1873,"type":1874,"processTemplateParams":5,"innerHTML":1875,"tagPosition":1876,"tagPriority":1351},"nuxt-og-image-overrides","application/json",{"title":14,"excerpt":15},"bodyClose",[1878,1881,1884,1887,1890,1892,1895,1897,1899,1901],{"property":1879,"content":1880},"og:image","/__og-image__/image/articles/daisy-chaining-laravel-jobs/og.png",{"property":1882,"content":1883},"og:image:width",1200,{"property":1885,"content":1886},"og:image:height",600,{"property":1888,"content":1889},"og:image:type","image/png",{"property":1891},"og:image:alt",{"name":1893,"content":1894},"twitter:card","summary_large_image",{"name":1896,"content":1880},"twitter:image:src",{"name":1898,"content":1883},"twitter:image:width",{"name":1900,"content":1886},"twitter:image:height",{"name":1902},"twitter:image:alt",["ShallowRef",1904],["ShallowReactive",1905],{"/articles/daisy-chaining-laravel-jobs":1906},[1907,1930],{"_path":1908,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":1909,"description":1910,"layout":16,"publishAt":1911,"ogImage":5,"_type":1865,"_id":1912,"_source":1867,"_file":1913,"_extension":1869,"head":1914},"/articles/2024-halftime-report","2024 Halftime Report","To be honest I don't know how to best describe what this year has been so far. What I am sure of is there are a handful of things I am grateful for..","2024-06-30","content:2.articles:2024-halftime-report.md","2.articles/2024-halftime-report.md",{"script":1915,"meta":1918},[1916],{"id":1873,"type":1874,"processTemplateParams":5,"innerHTML":1917,"tagPosition":1876,"tagPriority":1351},{"title":1909,"excerpt":1910},[1919,1921,1922,1923,1924,1925,1926,1927,1928,1929],{"property":1879,"content":1920},"/__og-image__/image/articles/2024-halftime-report/og.png",{"property":1882,"content":1883},{"property":1885,"content":1886},{"property":1888,"content":1889},{"property":1891},{"name":1893,"content":1894},{"name":1896,"content":1920},{"name":1898,"content":1883},{"name":1900,"content":1886},{"name":1902},{"_path":1931,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":1932,"description":1933,"layout":16,"publishAt":1934,"ogImage":5,"_type":1865,"_id":1935,"_source":1867,"_file":1936,"_extension":1869,"head":1937},"/articles/migrated-to-nuxt-content","Migrated To Nuxt Content","I just migrated my personal site from Statamic into Nuxt. I am using the nuxt-content module configured to be document driven.","2024-05-28","content:2.articles:migrated-to-nuxt-content.md","2.articles/migrated-to-nuxt-content.md",{"script":1938,"meta":1941},[1939],{"id":1873,"type":1874,"processTemplateParams":5,"innerHTML":1940,"tagPosition":1876,"tagPriority":1351},{"title":1932,"excerpt":1933},[1942,1944,1945,1946,1947,1948,1949,1950,1951,1952],{"property":1879,"content":1943},"/__og-image__/image/articles/migrated-to-nuxt-content/og.png",{"property":1882,"content":1883},{"property":1885,"content":1886},{"property":1888,"content":1889},{"property":1891},{"name":1893,"content":1894},{"name":1896,"content":1943},{"name":1898,"content":1883},{"name":1900,"content":1886},{"name":1902},["ShallowRef",1954],{},[1956,1959],{"title":1957,"_path":1958},"Prince John","/",{"title":1960,"_path":1961,"children":1962},"Articles","/articles",[1963,1964,1965,1966,1967,1970],{"title":1960,"_path":1961},{"title":1909,"_path":1908,"layout":16},{"title":14,"_path":11,"layout":16},{"title":1932,"_path":1931,"layout":16},{"title":1968,"_path":1969,"layout":16},"The Best Way To Give A Gift","/articles/the-best-way-to-give-a-gift",{"title":1971,"_path":1972,"layout":16},"Year In Review 2023","/articles/year-in-review-2023",{"fa6-brands:x-twitter":1974,"fa6-brands:github":1978,"fa6-brands:linkedin":1981},{"left":1975,"top":1975,"width":1976,"height":1976,"rotate":1975,"vFlip":6,"hFlip":6,"body":1977},0,512,"\u003Cpath fill=\"currentColor\" d=\"M389.2 48h70.6L305.6 224.2L487 464H345L233.7 318.6L106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z\"/>",{"left":1975,"top":1975,"width":1979,"height":1976,"rotate":1975,"vFlip":6,"hFlip":6,"body":1980},496,"\u003Cpath fill=\"currentColor\" d=\"M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2\"/>",{"left":1975,"top":1975,"width":1982,"height":1976,"rotate":1975,"vFlip":6,"hFlip":6,"body":1983},448,"\u003Cpath fill=\"currentColor\" d=\"M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9z\"/>",{"env":1985,"name":1986,"url":1987},"production","princejohn.dev","https://princejohn.dev",["Reactive",1989],["Set"],["Reactive",1991],{},1723429253027]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{mdc:{components:{prose:true,map:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}},content:{locales:[],defaultLocale:"",integrity:1723429246622,experimental:{stripQueryParameters:false,advanceQuery:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:["layout"]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:{dark:"github-dark",default:"github-light"},langs:["css","php","blade","vue","js","ts","json","shell","yml"],highlighter:"shiki"},wsUrl:"",documentDriven:{page:true,navigation:true,surround:true,globals:{},layoutFallbacks:["theme"],injectPage:true},host:"",trailingSlash:false,search:"",contentHead:true,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"/",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>